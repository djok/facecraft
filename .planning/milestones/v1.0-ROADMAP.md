# Roadmap: Facecraft — Professional Docker Release

## Overview

Three phases transform the existing functional Dockerfiles into a professional Docker Hub release. Phase 1 hardens the Dockerfiles (CPU wheel source, model checksums, OCI labels, HEALTHCHECK). Phase 2 builds both images, verifies they are correct and self-contained, then wires up the Docker Compose orchestration layer. Phase 3 publishes both images to Docker Hub and rewrites the README for Hub-first consumption. The dependency chain is strict: correct Dockerfiles before building, built images before compose validation, stable image tags before writing documentation.

## Phases

**Phase Numbering:**
- Integer phases (1, 2, 3): Planned milestone work
- Decimal phases (2.1, 2.2): Urgent insertions (marked with INSERTED)

Decimal phases appear between their surrounding integers in numeric order.

- [x] **Phase 1: Dockerfile Hardening** - Patch the five concrete gaps in existing Dockerfiles so both images are correct and production-ready to build
- [x] **Phase 2: Build, Verify, and Orchestrate** - Build both images, run the verification checklist, then write and test docker-compose.yml
- [x] **Phase 3: Publish and Document** - Push images to Docker Hub and rewrite README for Hub-first quickstart

## Phase Details

### Phase 1: Dockerfile Hardening
**Goal**: Both Dockerfiles are correct, optimized, and ready to produce publishable images — no bloat, no missing integrity checks, no missing metadata
**Depends on**: Nothing (first phase)
**Requirements**: DOCK-01, DOCK-02, DOCK-03, DOCK-04, DOCK-05, DOCK-06
**Success Criteria** (what must be TRUE):
  1. The CPU Dockerfile installs CPU-only PyTorch wheels — running `python -c "import torch; print(torch.version.cuda)"` inside the built image prints `None`
  2. Each model download in both Dockerfiles has a SHA256 checksum verification step — if the checksum fails, the Docker build fails
  3. Both Dockerfiles include OCI standard labels (`org.opencontainers.image.source`, `.version`, `.description`, `.licenses`)
  4. A `.dockerignore` exists at repo root and excludes `.planning/`, `.git/`, `tests/`, `__pycache__/`, and `.env`
  5. Both Dockerfiles have `HEALTHCHECK` configured with `--start-period=180s` targeting the `/ready` endpoint
**Plans**: 2 plans in 1 wave

Plans:
- [x] 01-01: Patch Dockerfile.cpu — CPU-only wheels, SHA256 checksums, OCI labels, HEALTHCHECK
- [x] 01-02: Patch Dockerfile.gpu — SHA256 checksums, OCI labels, HEALTHCHECK, .dockerignore, Makefile update-checksums

### Phase 2: Build, Verify, and Orchestrate
**Goal**: Both Docker images are built, verified self-contained and correct, and a working docker-compose.yml exists for production deployment
**Depends on**: Phase 1
**Requirements**: COMP-01, COMP-02, COMP-03, COMP-04
**Success Criteria** (what must be TRUE):
  1. `docker run --network none djok/facecraft:cpu` starts successfully — the container comes up without any internet access, proving all models are bundled
  2. `docker run --rm djok/facecraft:cpu whoami` prints `appuser` — the image runs as a non-root user
  3. `docker compose --profile cpu up` starts the API and the `/health` endpoint returns 200
  4. `docker compose --profile gpu up` starts the GPU service with correct `deploy.resources.reservations.devices` syntax — no compose errors on parse
**Plans**: 2 plans in 2 waves

Plans:
- [x] 02-01-PLAN.md — Build both Docker images (CPU + GPU) and run full verification checklist (air-gap, non-root, CPU-only PyTorch, OCI labels)
- [x] 02-02-PLAN.md — Write docker-compose.yml with CPU and GPU profiles, inline env var docs, named volumes, GPU device reservation — validate syntax and test CPU profile

### Phase 3: Publish and Document
**Goal**: Images are live on Docker Hub and the README gives any developer everything they need to pull and run Facecraft immediately
**Depends on**: Phase 2
**Requirements**: DOCS-01, DOCS-02, DOCS-03, DOCS-04, DOCS-05, DOCS-06, DOCS-07, PUBL-01, PUBL-02, PUBL-03, PUBL-04
**Success Criteria** (what must be TRUE):
  1. `docker pull djok/facecraft:cpu && docker run -p 8000:8000 djok/facecraft:cpu` works from a clean machine with zero additional steps
  2. The README opens with a working `docker run` one-liner and a performance benchmark table before any other content
  3. The README contains a complete environment variable reference table, a bundled models inventory table, and an image size transparency section
  4. A smoke test passes on the pulled Hub image — `/health` returns 200 and a test portrait image processes successfully end-to-end
**Plans**: 3 plans in 2 waves

Plans:
- [x] 03-01-PLAN.md — Push :cpu and :gpu images to Docker Hub (docker login + docker push, no :latest tag)
- [x] 03-02-PLAN.md — Rewrite README.md with Hub-first quickstart, benchmarks, model table, env var reference, image sizes, volume examples, API overview
- [x] 03-03-PLAN.md — Smoke test pulled Hub image (health + processing) and sync README to Docker Hub description

## Progress

**Execution Order:**
Phases execute in numeric order: 1 → 2 → 3

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 1. Dockerfile Hardening | 2/2 | Complete | 2026-02-18 |
| 2. Build, Verify, and Orchestrate | 2/2 | Complete | 2026-02-18 |
| 3. Publish and Document | 3/3 | Complete | 2026-02-18 |
