---
phase: 01-dockerfile-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/Dockerfile.cpu
autonomous: true
must_haves:
  truths:
    - "CPU Dockerfile installs CPU-only PyTorch wheels -- torch.version.cuda is None inside the built image"
    - "Each model download in Dockerfile.cpu has SHA256 checksum verification -- build fails on mismatch"
    - "Dockerfile.cpu includes OCI standard labels (source, version, description, licenses)"
    - "Dockerfile.cpu HEALTHCHECK targets /ready with start-period=180s"
  artifacts:
    - path: "docker/Dockerfile.cpu"
      provides: "Hardened CPU Dockerfile with CPU wheels, checksums, OCI labels, HEALTHCHECK"
      contains: "extra-index-url.*download.pytorch.org/whl/cpu"
  key_links:
    - from: "docker/Dockerfile.cpu"
      to: "https://download.pytorch.org/whl/cpu"
      via: "--extra-index-url in pip wheel command"
      pattern: "extra-index-url.*whl/cpu"
    - from: "docker/Dockerfile.cpu"
      to: "sha256sum"
      via: "checksum verification after each model download"
      pattern: "sha256sum -c"
---

<objective>
Patch Dockerfile.cpu with four hardening changes: CPU-only PyTorch wheels, SHA256 model checksums, OCI standard labels, and HEALTHCHECK pointing to /ready with 180s start-period.

Purpose: Make the CPU Docker image correct (no wasted CUDA wheel bloat), verifiable (checksum integrity), identifiable (OCI metadata), and observable (readiness probe).
Output: Updated `docker/Dockerfile.cpu`
</objective>

<execution_context>
@/home/rosen/.claude/get-shit-done/workflows/execute-plan.md
@/home/rosen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-dockerfile-hardening/01-RESEARCH.md
@docker/Dockerfile.cpu
@requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CPU-only PyTorch wheel index and SHA256 model checksums</name>
  <files>docker/Dockerfile.cpu</files>
  <action>
  Make two changes to `docker/Dockerfile.cpu`:

  **1. CPU-only PyTorch wheels (Stage 2: builder)**

  In the builder stage, change the `pip wheel` command to add the CPU-only PyTorch wheel index:

  ```dockerfile
  RUN pip wheel --no-cache-dir --wheel-dir /wheels \
      --extra-index-url https://download.pytorch.org/whl/cpu \
      -r requirements.txt
  ```

  Use `--extra-index-url` (NOT `--index-url`) so non-PyTorch packages still resolve from PyPI. The `requirements.txt` pins `torch==2.0.1` and `torchvision==0.15.2` -- pip will resolve the `+cpu` variants from the extra index.

  **2. SHA256 checksums (Stage 1: model-downloader)**

  Add ARG declarations at the top of the model-downloader stage for the three model hashes. Use placeholder values that MUST be computed from live downloads:

  ```dockerfile
  FROM python:3.11-slim AS model-downloader
  WORKDIR /models

  # SHA256 checksums for model integrity verification
  # Run `make update-checksums` to recompute after model source changes
  ARG SHAPE_PREDICTOR_SHA256=PLACEHOLDER_COMPUTE_DURING_BUILD
  ARG CODEFORMER_SHA256=PLACEHOLDER_COMPUTE_DURING_BUILD
  ARG U2NET_SHA256=PLACEHOLDER_COMPUTE_DURING_BUILD
  ```

  Then modify each download step to verify the checksum after download. Follow the "silent on success, loud on failure" principle using `sha256sum -c --quiet`:

  **dlib shape predictor** -- verify the UNCOMPRESSED .dat file (after bunzip2):
  ```dockerfile
  RUN wget -q http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2 \
      && bunzip2 shape_predictor_68_face_landmarks.dat.bz2 \
      && echo "${SHAPE_PREDICTOR_SHA256}  shape_predictor_68_face_landmarks.dat" | sha256sum -c --quiet
  ```

  **CodeFormer model** -- verify the .pth file:
  ```dockerfile
  RUN mkdir -p codeformer \
      && wget -q https://github.com/sczhou/CodeFormer/releases/download/v0.1.0/codeformer.pth \
         -O codeformer/codeformer.pth \
      && echo "${CODEFORMER_SHA256}  codeformer/codeformer.pth" | sha256sum -c --quiet
  ```

  **u2net model** -- verify after rembg downloads it. The model file is at `/root/.u2net/u2net_human_seg.onnx`:
  ```dockerfile
  RUN pip install --no-cache-dir "rembg[cpu]" \
      && python -c "from rembg import new_session; new_session('u2net_human_seg')" \
      && echo "${U2NET_SHA256}  /root/.u2net/u2net_human_seg.onnx" | sha256sum -c --quiet \
      && cp -r /root/.u2net /models/u2net
  ```

  Remove the old `echo "Downloaded: ..."` lines -- they are replaced by silent checksum verification.

  **IMPORTANT:** The actual SHA256 hashes are not known yet. The placeholder values will cause the build to fail intentionally until real hashes are computed using `make update-checksums` (created in plan 01-02). To compute them now, download each model file locally and run `sha256sum` on it. If you can download and compute the real hashes during execution, do so and use those values instead of placeholders.
  </action>
  <verify>
  Read back docker/Dockerfile.cpu and confirm:
  1. `--extra-index-url https://download.pytorch.org/whl/cpu` present in builder stage pip wheel command
  2. Three `ARG *_SHA256=` declarations in model-downloader stage
  3. Each model download followed by `sha256sum -c --quiet` verification
  4. No `echo "Downloaded:` lines remain in the model-downloader stage
  </verify>
  <done>
  Builder stage uses CPU-only wheel index. All three model downloads have SHA256 checksum verification that fails the build on mismatch and is silent on success.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace legacy labels with OCI standard labels and update HEALTHCHECK</name>
  <files>docker/Dockerfile.cpu</files>
  <action>
  Make two changes to `docker/Dockerfile.cpu` in the production stage (Stage 3):

  **1. OCI Standard Labels**

  Replace the existing legacy labels:
  ```dockerfile
  LABEL maintainer="OBVT Toolbox"
  LABEL description="Facecraft - AI Portrait Processing API (CPU)"
  LABEL version="1.0.0"
  ```

  With OCI standard labels (single LABEL instruction):
  ```dockerfile
  LABEL org.opencontainers.image.source="https://github.com/djok/facecraft" \
        org.opencontainers.image.version="1.0.0" \
        org.opencontainers.image.description="Facecraft - AI Portrait Processing API (CPU)" \
        org.opencontainers.image.licenses="MIT" \
        org.opencontainers.image.title="facecraft" \
        org.opencontainers.image.vendor="OBVT Toolbox"
  ```

  Per user decision: source URL is `https://github.com/djok/facecraft`, license is MIT.

  **2. HEALTHCHECK Update**

  Replace the existing HEALTHCHECK:
  ```dockerfile
  HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
      CMD curl -f http://localhost:8000/health || exit 1
  ```

  With:
  ```dockerfile
  HEALTHCHECK --interval=30s --timeout=10s --start-period=180s --retries=3 \
      CMD curl -f http://localhost:8000/ready || exit 1
  ```

  Changes: `/health` -> `/ready` (checks model readiness, not just process liveness), `--start-period=120s` -> `--start-period=180s` (adequate time for model loading per project decision).
  </action>
  <verify>
  Read back docker/Dockerfile.cpu and confirm:
  1. No `LABEL maintainer=`, `LABEL description=`, `LABEL version=` lines exist
  2. `org.opencontainers.image.source`, `.version`, `.description`, `.licenses` all present
  3. HEALTHCHECK uses `/ready` endpoint
  4. HEALTHCHECK has `--start-period=180s`
  </verify>
  <done>
  Dockerfile.cpu uses OCI standard labels with all required fields (source, version, description, licenses). HEALTHCHECK targets /ready endpoint with 180s start-period.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full Dockerfile.cpu:

1. **CPU wheel index:** grep for `extra-index-url.*whl/cpu` -- must be present in builder stage
2. **No legacy labels:** grep for `LABEL maintainer` -- must NOT be present
3. **OCI labels:** grep for `org.opencontainers.image.source` -- must be present
4. **Checksum verification:** grep for `sha256sum -c` -- must appear 3 times (one per model)
5. **HEALTHCHECK endpoint:** grep for `/ready` -- must be present in HEALTHCHECK line
6. **Start period:** grep for `start-period=180s` -- must be present
7. **Multi-stage structure preserved:** FROM lines should still show 3 stages (model-downloader, builder, production)
</verification>

<success_criteria>
- docker/Dockerfile.cpu contains `--extra-index-url https://download.pytorch.org/whl/cpu` in builder stage
- docker/Dockerfile.cpu has 3 SHA256 ARG declarations and 3 `sha256sum -c --quiet` verification steps
- docker/Dockerfile.cpu uses only `org.opencontainers.image.*` labels (no legacy LABEL format)
- docker/Dockerfile.cpu HEALTHCHECK targets `/ready` with `--start-period=180s`
- Multi-stage build structure is preserved (3 stages)
</success_criteria>

<output>
After completion, create `.planning/phases/01-dockerfile-hardening/01-01-SUMMARY.md`
</output>
