---
phase: 03-publish-and-document
plan: 03
type: execute
wave: 2
depends_on:
  - "03-01"
  - "03-02"
files_modified:
  - scripts/smoke-test.sh
autonomous: false

must_haves:
  truths:
    - "Pulled Hub image starts and /health returns 200"
    - "A test portrait processes successfully end-to-end via /api/v1/process/quick"
    - "Docker Hub repository description matches README.md content"
  artifacts:
    - path: "scripts/smoke-test.sh"
      provides: "Executable smoke test script for Hub images"
      min_lines: 40
  key_links:
    - from: "scripts/smoke-test.sh"
      to: "Docker Hub djok/facecraft:cpu"
      via: "docker pull + docker run"
      pattern: "docker pull.*djok/facecraft"
    - from: "scripts/smoke-test.sh"
      to: "/health endpoint"
      via: "curl health check"
      pattern: "curl.*localhost.*health"
    - from: "scripts/smoke-test.sh"
      to: "/api/v1/process/quick"
      via: "curl image upload"
      pattern: "curl.*process/quick"
    - from: "README.md"
      to: "Docker Hub full_description"
      via: "Hub API PATCH"
      pattern: "hub.docker.com/v2/repositories"
---

<objective>
Run a smoke test against the pulled Docker Hub images and sync the README to the Docker Hub repository description.

Purpose: Prove the published images work end-to-end for a real user (pull, start, health check, process image), and ensure the Hub overview matches the README.
Output: Passing smoke test, synced Hub description, smoke test script committed to repo.
</objective>

<execution_context>
@/home/rosen/.claude/get-shit-done/workflows/execute-plan.md
@/home/rosen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-publish-and-document/03-RESEARCH.md
@.planning/phases/03-publish-and-document/03-01-SUMMARY.md
@.planning/phases/03-publish-and-document/03-02-SUMMARY.md
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create smoke test script and run against pulled CPU image</name>
  <files>scripts/smoke-test.sh</files>
  <action>
    Create `scripts/smoke-test.sh` -- a self-contained bash script that validates a pulled Docker Hub image works end-to-end.

    The script must:

    1. Accept an optional image tag argument (default: `djok/facecraft:cpu`):
       ```bash
       IMAGE="${1:-djok/facecraft:cpu}"
       ```

    2. Pull the image fresh from Docker Hub:
       ```bash
       docker pull "$IMAGE"
       ```

    3. Start the container in detached mode with a unique name:
       ```bash
       CONTAINER_NAME="facecraft-smoke-$$"
       docker run -d --name "$CONTAINER_NAME" -p 8000:8000 "$IMAGE"
       ```

    4. Wait for `/health` to return 200 with a retry loop (max 300s / 5 min to accommodate model loading):
       ```bash
       elapsed=0
       until curl -sf http://localhost:8000/health > /dev/null 2>&1; do
         sleep 5; elapsed=$((elapsed + 5))
         if [ "$elapsed" -ge 300 ]; then
           echo "FAIL: /health not responding after 300s"
           docker logs "$CONTAINER_NAME"
           docker rm -f "$CONTAINER_NAME"
           exit 1
         fi
       done
       ```

    5. Obtain a test portrait for face detection. The project has no test images, so download a public-domain portrait during test setup. Use a small, reliable source -- for example, generate a simple portrait-like test image using Python inside the running container (the container has Pillow/PIL installed), OR download from a stable URL. **Best approach:** Check if the repo has any test images first. If not, use the Unsplash API or a direct URL to a CC0 portrait. As a fallback, check if there are any .jpg/.png files anywhere in the repo that could serve as a test portrait.

       If no suitable test image can be found or downloaded, create a minimal Python script that generates a synthetic face-like image using PIL (draw an oval + two dots for eyes) and save it. While this is not a real face, it tests the HTTP plumbing. Note in the script output whether the image was a real portrait or synthetic.

       Alternatively -- and this is preferred -- ask the user in a checkpoint if they have a test portrait image. But since this task is auto, use whatever is available.

    6. POST the test portrait to `/api/v1/process/quick` and verify the response:
       ```bash
       HTTP_CODE=$(curl -s -o /tmp/smoke-output.png -w "%{http_code}" \
         -X POST http://localhost:8000/api/v1/process/quick \
         -F "file=@$TEST_IMAGE")
       ```
       If HTTP 200: verify output is a valid PNG using `file` command (check for "PNG image" in output).
       If HTTP 400 "No face could be detected": note this but do NOT fail the test if the image was synthetic. The HTTP plumbing works.
       If other error: FAIL.

    7. Cleanup: stop and remove the container, delete temp files.
       ```bash
       docker rm -f "$CONTAINER_NAME"
       rm -f /tmp/smoke-output.png
       ```

    8. Print clear PASS/FAIL summary.

    Make the script executable: `chmod +x scripts/smoke-test.sh`

    **Then run the smoke test:**
    ```bash
    bash scripts/smoke-test.sh djok/facecraft:cpu
    ```

    The test will take several minutes (image pull if not cached + model loading startup).

    IMPORTANT: If the container is already running on port 8000, stop it first. Check with `docker ps --filter "publish=8000"`.
  </action>
  <verify>
    `scripts/smoke-test.sh` exists and is executable.
    Running the script produces output ending with "PASS" or clearly indicates what succeeded/failed.
    At minimum: `/health` returns 200 from the pulled Hub image.
  </verify>
  <done>
    Smoke test script exists at scripts/smoke-test.sh. The CPU image pulled from Docker Hub starts successfully, /health returns 200, and image processing has been attempted (success depends on test portrait availability).
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Sync README to Docker Hub description</name>
  <action>
    The Docker Hub API requires authentication with the user's Docker Hub credentials to update the repository description. Claude will prepare the exact command, but the user must provide credentials or run the command.
  </action>
  <instructions>
    Run the following commands to sync your README.md as the Docker Hub repository description:

    **Step 1 -- Get a JWT token** (replace YOUR_PASSWORD with your Docker Hub password or PAT):
    ```bash
    TOKEN=$(curl -s -H "Content-Type: application/json" \
      -X POST -d '{"username":"djok","password":"YOUR_PASSWORD"}' \
      https://hub.docker.com/v2/users/login/ | jq -r .token)
    ```

    **Step 2 -- Sync README to Hub:**
    ```bash
    README_JSON=$(jq -Rs . < README.md)
    curl -s -X PATCH -L \
      "https://hub.docker.com/v2/repositories/djok/facecraft/" \
      -H "Content-Type: application/json" \
      -H "Authorization: JWT ${TOKEN}" \
      -d "{\"description\":\"AI portrait processing API - background removal, face detection, alignment, enhancement\",\"full_description\":${README_JSON}}"
    ```

    **Verify:** Visit https://hub.docker.com/r/djok/facecraft and confirm the Overview tab shows the updated README content.

    If you prefer NOT to sync the Hub description now, type "skip" and this can be done later.
  </instructions>
  <resume-signal>Type "synced" if Hub description updated, "skip" to defer, or paste any error</resume-signal>
</task>

</tasks>

<verification>
- `scripts/smoke-test.sh` is executable and committed
- Smoke test against `djok/facecraft:cpu` passes (at minimum: pull succeeds, container starts, /health returns 200)
- Docker Hub description reflects README.md content (or explicitly deferred by user)
</verification>

<success_criteria>
A smoke test proves the published CPU image works: pull from Hub, start, health check returns 200, and image processing is attempted. The smoke test script is committed to the repo for future use. Docker Hub repository description is synced (or consciously deferred).
</success_criteria>

<output>
After completion, create `.planning/phases/03-publish-and-document/03-03-SUMMARY.md`
</output>
