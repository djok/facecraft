---
phase: 01-dockerfile-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/Dockerfile.gpu
  - .dockerignore
  - Makefile
autonomous: true
must_haves:
  truths:
    - "Each model download in Dockerfile.gpu has SHA256 checksum verification -- build fails on mismatch"
    - "Dockerfile.gpu includes OCI standard labels (source, version, description, licenses)"
    - "Dockerfile.gpu HEALTHCHECK targets /ready with start-period=180s"
    - ".dockerignore excludes .planning/, .git/, tests/, __pycache__/, and .env"
    - "make update-checksums target exists and patches both Dockerfiles with computed hashes"
  artifacts:
    - path: "docker/Dockerfile.gpu"
      provides: "Hardened GPU Dockerfile with checksums, OCI labels, HEALTHCHECK"
      contains: "sha256sum -c"
    - path: ".dockerignore"
      provides: "Build context exclusions including .planning/"
      contains: ".planning"
    - path: "Makefile"
      provides: "Developer tooling including update-checksums target"
      contains: "update-checksums"
  key_links:
    - from: "docker/Dockerfile.gpu"
      to: "sha256sum"
      via: "checksum verification after each model download"
      pattern: "sha256sum -c"
    - from: "Makefile"
      to: "docker/Dockerfile.cpu"
      via: "sed patching of ARG SHA256 values"
      pattern: "sed.*SHAPE_PREDICTOR_SHA256"
    - from: "Makefile"
      to: "docker/Dockerfile.gpu"
      via: "sed patching of ARG SHA256 values"
      pattern: "sed.*SHAPE_PREDICTOR_SHA256"
---

<objective>
Patch Dockerfile.gpu with three hardening changes (SHA256 model checksums, OCI standard labels, HEALTHCHECK), add .planning/ to .dockerignore, and create the Makefile with update-checksums target.

Purpose: Complete the GPU image hardening, ensure .planning/ is excluded from Docker build context, and provide developer tooling for maintaining model checksums.
Output: Updated `docker/Dockerfile.gpu`, updated `.dockerignore`, new `Makefile`
</objective>

<execution_context>
@/home/rosen/.claude/get-shit-done/workflows/execute-plan.md
@/home/rosen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-dockerfile-hardening/01-RESEARCH.md
@docker/Dockerfile.gpu
@.dockerignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SHA256 model checksums, OCI labels, and HEALTHCHECK to Dockerfile.gpu</name>
  <files>docker/Dockerfile.gpu</files>
  <action>
  Make three changes to `docker/Dockerfile.gpu`:

  **1. SHA256 checksums (Stage 1: model-downloader)**

  Add ARG declarations at the top of the model-downloader stage (same hash values as Dockerfile.cpu -- both files are self-contained per user decision):

  ```dockerfile
  FROM python:3.11-slim AS model-downloader
  WORKDIR /models

  # SHA256 checksums for model integrity verification
  # Run `make update-checksums` to recompute after model source changes
  ARG SHAPE_PREDICTOR_SHA256=PLACEHOLDER_COMPUTE_DURING_BUILD
  ARG CODEFORMER_SHA256=PLACEHOLDER_COMPUTE_DURING_BUILD
  ARG U2NET_SHA256=PLACEHOLDER_COMPUTE_DURING_BUILD
  ```

  Modify each download step identically to Dockerfile.cpu -- verify with `sha256sum -c --quiet` (silent on success, loud on failure):

  **dlib shape predictor:**
  ```dockerfile
  RUN wget -q http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2 \
      && bunzip2 shape_predictor_68_face_landmarks.dat.bz2 \
      && echo "${SHAPE_PREDICTOR_SHA256}  shape_predictor_68_face_landmarks.dat" | sha256sum -c --quiet
  ```

  **CodeFormer model:**
  ```dockerfile
  RUN mkdir -p codeformer \
      && wget -q https://github.com/sczhou/CodeFormer/releases/download/v0.1.0/codeformer.pth \
         -O codeformer/codeformer.pth \
      && echo "${CODEFORMER_SHA256}  codeformer/codeformer.pth" | sha256sum -c --quiet
  ```

  **u2net model:**
  ```dockerfile
  RUN pip install --no-cache-dir "rembg[cpu]" \
      && python -c "from rembg import new_session; new_session('u2net_human_seg')" \
      && echo "${U2NET_SHA256}  /root/.u2net/u2net_human_seg.onnx" | sha256sum -c --quiet \
      && cp -r /root/.u2net /models/u2net
  ```

  Remove the old `echo "Downloaded: ..."` lines.

  **2. OCI Standard Labels (Stage 3: production)**

  Replace existing legacy labels:
  ```dockerfile
  LABEL maintainer="OBVT Toolbox"
  LABEL description="Facecraft - AI Portrait Processing API (GPU/CUDA)"
  LABEL version="1.0.0"
  ```

  With OCI standard labels:
  ```dockerfile
  LABEL org.opencontainers.image.source="https://github.com/djok/facecraft" \
        org.opencontainers.image.version="1.0.0" \
        org.opencontainers.image.description="Facecraft - AI Portrait Processing API (GPU/CUDA)" \
        org.opencontainers.image.licenses="MIT" \
        org.opencontainers.image.title="facecraft" \
        org.opencontainers.image.vendor="OBVT Toolbox"
  ```

  Note: description says "GPU/CUDA" (not "CPU") to distinguish from the CPU image.

  **3. HEALTHCHECK Update (Stage 3: production)**

  Replace:
  ```dockerfile
  HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
      CMD curl -f http://localhost:8000/health || exit 1
  ```

  With:
  ```dockerfile
  HEALTHCHECK --interval=30s --timeout=10s --start-period=180s --retries=3 \
      CMD curl -f http://localhost:8000/ready || exit 1
  ```

  **DO NOT change the CUDA base image versions.** Research found that upgrading from CUDA 12.1.0 to 12.4.1 provides no benefit while PyTorch 2.0.1 is pinned to cu118 wheels. Keep `nvidia/cuda:12.1.0-cudnn8-devel-ubuntu22.04` (builder) and `nvidia/cuda:12.1.0-cudnn8-runtime-ubuntu22.04` (runtime) as-is.

  **IMPORTANT:** The SHA256 placeholder values will be replaced by real hashes using the `make update-checksums` target (Task 3). If you can download and compute the real hashes during execution, do so and use those values in BOTH Dockerfiles.
  </action>
  <verify>
  Read back docker/Dockerfile.gpu and confirm:
  1. Three `ARG *_SHA256=` declarations in model-downloader stage
  2. Each model download followed by `sha256sum -c --quiet` verification
  3. No `echo "Downloaded:` lines remain in model-downloader stage
  4. No `LABEL maintainer=` lines exist
  5. `org.opencontainers.image.source`, `.version`, `.description`, `.licenses` all present
  6. HEALTHCHECK uses `/ready` endpoint with `--start-period=180s`
  7. CUDA base images remain as `nvidia/cuda:12.1.0-cudnn8-*` (NOT upgraded)
  </verify>
  <done>
  Dockerfile.gpu has SHA256 checksum verification for all 3 models, OCI standard labels, and HEALTHCHECK targeting /ready with 180s start-period. CUDA base images unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update .dockerignore and create Makefile with update-checksums target</name>
  <files>.dockerignore, Makefile</files>
  <action>
  **1. Update .dockerignore**

  Add `.planning/` to the existing `.dockerignore` file. Place it near the top, after the `.git` entry. The file already excludes `.git`, `tests`, `__pycache__`, `.env` -- the only missing exclusion per requirements is `.planning/`.

  Add this line after the `.gitignore` line:
  ```
  .planning
  ```

  **2. Create Makefile**

  Create a new `Makefile` at the repo root with an `update-checksums` target. This target downloads all three models, computes their SHA256 hashes, and patches both Dockerfiles using `sed`.

  ```makefile
  .PHONY: update-checksums

  # Download models and update SHA256 checksums in both Dockerfiles
  update-checksums:
  	@echo "Computing model checksums..."
  	@# Shape predictor (download compressed, hash uncompressed)
  	@wget -q http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2 -O /tmp/gsd_sp.bz2
  	@bunzip2 -f /tmp/gsd_sp.bz2
  	@SP_HASH=$$(sha256sum /tmp/gsd_sp | awk '{print $$1}') && \
  		echo "  shape_predictor: $$SP_HASH" && \
  		sed -i "s/^ARG SHAPE_PREDICTOR_SHA256=.*/ARG SHAPE_PREDICTOR_SHA256=$$SP_HASH/" \
  			docker/Dockerfile.cpu docker/Dockerfile.gpu
  	@rm -f /tmp/gsd_sp
  	@# CodeFormer
  	@wget -q https://github.com/sczhou/CodeFormer/releases/download/v0.1.0/codeformer.pth -O /tmp/gsd_cf.pth
  	@CF_HASH=$$(sha256sum /tmp/gsd_cf.pth | awk '{print $$1}') && \
  		echo "  codeformer: $$CF_HASH" && \
  		sed -i "s/^ARG CODEFORMER_SHA256=.*/ARG CODEFORMER_SHA256=$$CF_HASH/" \
  			docker/Dockerfile.cpu docker/Dockerfile.gpu
  	@rm -f /tmp/gsd_cf.pth
  	@# u2net_human_seg (requires Python with rembg)
  	@python -c "from rembg import new_session; new_session('u2net_human_seg')" 2>/dev/null
  	@U2_HASH=$$(sha256sum $$HOME/.u2net/u2net_human_seg.onnx | awk '{print $$1}') && \
  		echo "  u2net_human_seg: $$U2_HASH" && \
  		sed -i "s/^ARG U2NET_SHA256=.*/ARG U2NET_SHA256=$$U2_HASH/" \
  			docker/Dockerfile.cpu docker/Dockerfile.gpu
  	@echo "Checksums updated in docker/Dockerfile.cpu and docker/Dockerfile.gpu"
  ```

  Notes on the Makefile:
  - Uses `@` prefix to suppress command echo (clean output)
  - Downloads to `/tmp/gsd_*` to avoid polluting the working directory
  - Cleans up temp files after each hash computation
  - The u2net step requires `rembg` to be installed in the local Python environment (it uses `python -c` to trigger the model download to `~/.u2net/`)
  - Uses `sed -i` to patch the ARG lines in both Dockerfiles simultaneously
  - Prints each computed hash for verification
  - MUST use tabs (not spaces) for Makefile recipe indentation
  </action>
  <verify>
  1. Read .dockerignore and confirm `.planning` is listed as an exclusion
  2. Read Makefile and confirm:
     - `.PHONY: update-checksums` declaration exists
     - Three model hash computations (shape predictor, codeformer, u2net)
     - `sed -i` commands target both `docker/Dockerfile.cpu` and `docker/Dockerfile.gpu`
     - Temp files cleaned up
  3. Run `make -n update-checksums` (dry run) to verify Makefile syntax is valid
  </verify>
  <done>
  .dockerignore includes .planning/ exclusion. Makefile exists with update-checksums target that downloads all three models, computes SHA256 hashes, and patches both Dockerfiles.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Dockerfile.gpu checksums:** grep for `sha256sum -c` in docker/Dockerfile.gpu -- must appear 3 times
2. **Dockerfile.gpu OCI labels:** grep for `org.opencontainers.image.source` -- must be present
3. **Dockerfile.gpu HEALTHCHECK:** grep for `/ready` and `start-period=180s` -- both must be present
4. **Dockerfile.gpu CUDA version:** grep for `nvidia/cuda:12.1.0` -- must still be present (NOT 12.4.1)
5. **.dockerignore:** grep for `.planning` -- must be present
6. **Makefile:** `make -n update-checksums` succeeds (valid syntax)
7. **Makefile patches both files:** grep for `Dockerfile.cpu docker/Dockerfile.gpu` in Makefile -- sed targets both
</verification>

<success_criteria>
- docker/Dockerfile.gpu has 3 SHA256 ARG declarations and 3 `sha256sum -c --quiet` verification steps
- docker/Dockerfile.gpu uses only `org.opencontainers.image.*` labels (no legacy LABEL format)
- docker/Dockerfile.gpu HEALTHCHECK targets `/ready` with `--start-period=180s`
- docker/Dockerfile.gpu keeps nvidia/cuda:12.1.0 base images (no CUDA upgrade)
- .dockerignore includes `.planning` exclusion
- Makefile exists at repo root with working `update-checksums` target
- Makefile `update-checksums` target patches both Dockerfile.cpu and Dockerfile.gpu
</success_criteria>

<output>
After completion, create `.planning/phases/01-dockerfile-hardening/01-02-SUMMARY.md`
</output>
